package main

import "testing"

func TestRetrieveContainerIDFromMountInfo(t *testing.T) {
	testCases := []struct {
		name       string
		content    string
		expectedID string
	}{
		{
			name:       "Valid - Docker with Prefix /docker/containers/",
			content:    "720 512 0:169 / rw,relatime - overlay rw,lowerdir=/var/lib/docker/overlay2/l/BWFK4VNMAREHLMCM4OY7TFOFAO:/var/lib/docker/overlay2/l/GHTFN3QRQOLCM6CJOUY7A26DTE:/var/lib/docker/overlay2/l/ELQIJZBHH4CPJZJJGD6HQOT7VK:/var/lib/docker/overlay2/l/B5VS7M5ENDKAJ4F5D6I4T4WWF3:/var/lib/docker/overlay2/l/WUSSB37HFNFMZAD43GTLFNRLYE:/var/lib/docker/overlay2/l/SFQSU23EIC3BVCB57XQXFSOEBC:/var/lib/docker/overlay2/l/BMD2U4NK6FYDZ6ZG7QNSVF3OZT:/var/lib/docker/overlay2/l/I5LQ2OQKHKBVGF3FOWCACQZND4,upperdir=/var/lib/docker/overlay2/4bc476b9ee59f34060d74bc02243c72daea36aaa9c1d3ad86573894f18c48f1a/diff,workdir=/var/lib/docker/overlay2/4bc476b9ee59f34060d74bc02243c72daea36aaa9c1d3ad86573894f18c48f1a/work\n722 720 0:213 / /proc rw,nosuid,nodev,noexec,relatime - proc rw\n723 720 0:215 / /dev rw,nosuid - tmpfs rw,size=65536k,mode=755\n724 723 0:216 / /dev/pts rw,nosuid,noexec,relatime - devpts rw,gid=5,mode=620,ptmxmode=666\n725 720 0:217 / /sys ro,nosuid,nodev,noexec,relatime - sysfs ro\n726 725 0:39 / /sys/fs/cgroup ro,nosuid,nodev,noexec,relatime - cgroup2 cgroup rw\n727 723 0:210 / /dev/mqueue rw,nosuid,nodev,noexec,relatime - mqueue rw\n728 723 0:218 / /dev/shm rw,nosuid,nodev,noexec,relatime - tmpfs shm rw,size=65536k\n729 720 254:1 /docker/containers/fb051c3484249676f930579db7d668d9f7dc66a936e4ebfd0adec42c0f69268f/resolv.conf /etc/resolv.conf rw,relatime - ext4 /dev/vda1 rw,discard\n730 720 254:1 /docker/containers/fb051c3484249676f930579db7d668d9f7dc66a936e4ebfd0adec42c0f69268f/hostname /etc/hostname rw,relatime - ext4 /dev/vda1 rw,discard\n731 720 254:1 /docker/containers/fb051c3484249676f930579db7d668d9f7dc66a936e4ebfd0adec42c0f69268f/hosts /etc/hosts rw,relatime - ext4 /dev/vda1 rw,discard\n513 722 0:213 /bus /proc/bus ro,nosuid,nodev,noexec,relatime - proc rw\n516 722 0:213 /fs /proc/fs ro,nosuid,nodev,noexec,relatime - proc rw\n560 722 0:213 /irq /proc/irq ro,nosuid,nodev,noexec,relatime - proc rw\n576 722 0:213 /sys /proc/sys ro,nosuid,nodev,noexec,relatime - proc rw\n577 722 0:213 /sysrq-trigger /proc/sysrq-trigger ro,nosuid,nodev,noexec,relatime - proc rw\n578 722 0:215 /null /proc/interrupts rw,nosuid - tmpfs rw,size=65536k,mode=755\n579 722 0:215 /null /proc/kcore rw,nosuid - tmpfs rw,size=65536k,mode=755\n580 722 0:215 /null /proc/keys rw,nosuid - tmpfs rw,size=65536k,mode=755\n581 722 0:215 /null /proc/timer_list rw,nosuid - tmpfs rw,size=65536k,mode=755\n582 722 0:219 / /proc/scsi ro,relatime - tmpfs ro\n583 725 0:220 / /sys/firmware ro,relatime - tmpfs ro",
			expectedID: "fb051c3484249676f930579db7d668d9f7dc66a936e4ebfd0adec42c0f69268f",
		},
		{
			name:       "Valid - Docker without Prefix",
			content:    "7247 4546 0:1859 / rw,relatime - overlay rw,lowerdir=/var/lib/docker/overlay2/l/SRPWXYQXXSJSDMAPND2IXYVLKG:/var/lib/docker/overlay2/l/6UGD4BNLO3DKG3WESBBAIP2SCL:/var/lib/docker/overlay2/l/DAMUY3NMUHQEESEMGVAB6JB6LK:/var/lib/docker/overlay2/l/XUG2Z5UC44F3JPCXY7LDUNHCPU:/var/lib/docker/overlay2/l/E7ABQHJW6LS4U4UQKPBGBK4CXC:/var/lib/docker/overlay2/l/KBJMTB24OLRZMFB3QDAIH5YY5X:/var/lib/docker/overlay2/l/WVLB6KPTBGW446XN5T7NCGOXUF:/var/lib/docker/overlay2/l/THOZHTKKFQHPP2S2MGBICLT7DR,upperdir=/var/lib/docker/overlay2/3bb181c650e5d9843d1dbe326d7430326bf3a4e17c473c0811c6f7a01e7b2dca/diff,workdir=/var/lib/docker/overlay2/3bb181c650e5d9843d1dbe326d7430326bf3a4e17c473c0811c6f7a01e7b2dca/work,nouserxattr\n7249 7247 0:835 / /proc rw,nosuid,nodev,noexec,relatime - proc rw\n7250 7247 0:1786 / /dev rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n7251 7250 0:1816 / /dev/pts rw,nosuid,noexec,relatime - devpts rw,gid=5,mode=620,ptmxmode=666\n7252 7247 0:1907 / /sys ro,nosuid,nodev,noexec,relatime - sysfs ro\n7253 7252 0:30 / /sys/fs/cgroup ro,nosuid,nodev,noexec,relatime - cgroup2 cgroup rw,nsdelegate,memory_recursiveprot\n7254 7250 0:760 / /dev/mqueue rw,nosuid,nodev,noexec,relatime - mqueue rw\n7255 7250 0:1931 / /dev/shm rw,nosuid,nodev,noexec,relatime - tmpfs shm rw,size=65536k,inode64\n7256 7247 0:313 /dd0053d1d933778281e097f65870d45e1e729d8ff70f3979a4f8acd9c44de380/resolv.conf /etc/resolv.conf rw,nosuid,nodev,noexec,noatime - tmpfs log2ram rw,size=8290304k,mode=755,inode64\n7257 7247 0:313 /dd0053d1d933778281e097f65870d45e1e729d8ff70f3979a4f8acd9c44de380/hostname /etc/hostname rw,nosuid,nodev,noexec,noatime - tmpfs log2ram rw,size=8290304k,mode=755,inode64\n7258 7247 0:313 /dd0053d1d933778281e097f65870d45e1e729d8ff70f3979a4f8acd9c44de380/hosts /etc/hosts rw,nosuid,nodev,noexec,noatime - tmpfs log2ram rw,size=8290304k,mode=755,inode64\n4547 7249 0:835 /bus /proc/bus ro,nosuid,nodev,noexec,relatime - proc rw\n4548 7249 0:835 /fs /proc/fs ro,nosuid,nodev,noexec,relatime - proc rw\n5180 7249 0:835 /irq /proc/irq ro,nosuid,nodev,noexec,relatime - proc rw\n5181 7249 0:835 /sys /proc/sys ro,nosuid,nodev,noexec,relatime - proc rw\n5182 7249 0:835 /sysrq-trigger /proc/sysrq-trigger ro,nosuid,nodev,noexec,relatime - proc rw\n5183 7249 0:1932 / /proc/asound ro,relatime - tmpfs ro,inode64\n5184 7249 0:1933 / /proc/acpi ro,relatime - tmpfs ro,inode64\n5185 7249 0:1786 /null /proc/interrupts rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n5187 7249 0:1786 /null /proc/kcore rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n5188 7249 0:1786 /null /proc/keys rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n5189 7249 0:1786 /null /proc/latency_stats rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n5190 7249 0:1786 /null /proc/timer_list rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n5194 7249 0:1934 / /proc/scsi ro,relatime - tmpfs ro,inode64\n5196 7252 0:1937 / /sys/firmware ro,relatime - tmpfs ro,inode64\n5198 7252 0:1938 / /sys/devices/virtual/powercap ro,relatime - tmpfs ro,inode64\n5199 7252 0:1940 / /sys/devices/system/cpu/cpu0/thermal_throttle ro,relatime - tmpfs ro,inode64\n5200 7252 0:1973 / /sys/devices/system/cpu/cpu1/thermal_throttle ro,relatime - tmpfs ro,inode64\n5208 7252 0:1974 / /sys/devices/system/cpu/cpu2/thermal_throttle ro,relatime - tmpfs ro,inode64\n5212 7252 0:1975 / /sys/devices/system/cpu/cpu3/thermal_throttle ro,relatime - tmpfs ro,inode64\n5216 7252 0:1977 / /sys/devices/system/cpu/cpu4/thermal_throttle ro,relatime - tmpfs ro,inode64\n5217 7252 0:1980 / /sys/devices/system/cpu/cpu5/thermal_throttle ro,relatime - tmpfs ro,inode64\n5218 7252 0:1981 / /sys/devices/system/cpu/cpu6/thermal_throttle ro,relatime - tmpfs ro,inode64\n5219 7252 0:1982 / /sys/devices/system/cpu/cpu7/thermal_throttle ro,relatime - tmpfs ro,inode64\n5220 7252 0:1983 / /sys/devices/system/cpu/cpu8/thermal_throttle ro,relatime - tmpfs ro,inode64\n5221 7252 0:1984 / /sys/devices/system/cpu/cpu9/thermal_throttle ro,relatime - tmpfs ro,inode64\n5222 7252 0:1985 / /sys/devices/system/cpu/cpu10/thermal_throttle ro,relatime - tmpfs ro,inode64\n5223 7252 0:1986 / /sys/devices/system/cpu/cpu11/thermal_throttle ro,relatime - tmpfs ro,inode64\n5225 7252 0:1987 / /sys/devices/system/cpu/cpu12/thermal_throttle ro,relatime - tmpfs ro,inode64\n5226 7252 0:1988 / /sys/devices/system/cpu/cpu13/thermal_throttle ro,relatime - tmpfs ro,inode64\n5245 7252 0:1989 / /sys/devices/system/cpu/cpu14/thermal_throttle ro,relatime - tmpfs ro,inode64\n5269 7252 0:1990 / /sys/devices/system/cpu/cpu15/thermal_throttle ro,relatime - tmpfs ro,inode64\n5316 7252 0:1991 / /sys/devices/system/cpu/cpu16/thermal_throttle ro,relatime - tmpfs ro,inode64\n5351 7252 0:1992 / /sys/devices/system/cpu/cpu17/thermal_throttle ro,relatime - tmpfs ro,inode64\n5352 7252 0:1993 / /sys/devices/system/cpu/cpu18/thermal_throttle ro,relatime - tmpfs ro,inode64\n5383 7252 0:1994 / /sys/devices/system/cpu/cpu19/thermal_throttle ro,relatime - tmpfs ro,inode64\n5384 7252 0:1995 / /sys/devices/system/cpu/cpu20/thermal_throttle ro,relatime - tmpfs ro,inode64\n5424 7252 0:1996 / /sys/devices/system/cpu/cpu21/thermal_throttle ro,relatime - tmpfs ro,inode64\n5447 7252 0:1997 / /sys/devices/system/cpu/cpu22/thermal_throttle ro,relatime - tmpfs ro,inode64\n5455 7252 0:1998 / /sys/devices/system/cpu/cpu23/thermal_throttle ro,relatime - tmpfs ro,inode64",
			expectedID: "dd0053d1d933778281e097f65870d45e1e729d8ff70f3979a4f8acd9c44de380",
		},
		{
			name:       "Valid - Podman with Prefix /container/",
			content:    "1961 1841 0:254 / rw,relatime - overlay rw,lowerdir=/mnt/.ix-apps/docker/overlay2/l/DC25XJYUEXLJAMP73JW4DYLHAI:/mnt/.ix-apps/docker/overlay2/l/FZMCWDZPIAO3M3D3OCAYMONPKD:/mnt/.ix-apps/docker/overlay2/l/E6WSG2CUSKAV4OCL6K23VWJGRT:/mnt/.ix-apps/docker/overlay2/l/4H4VSAVK42G7U3K5T72Z4IXAAU:/mnt/.ix-apps/docker/overlay2/l/IGVZNDZTKYP6RMYXWJ3DFC52LU:/mnt/.ix-apps/docker/overlay2/l/AATXNHIPW4ZOKZUEOIB2MRG2AB:/mnt/.ix-apps/docker/overlay2/l/2R3HFPKNTU4Q4LKAL67ECI5VIU:/mnt/.ix-apps/docker/overlay2/l/BFRDQ33R4T5KFACE3DBGT6O2J4,upperdir=/mnt/.ix-apps/docker/overlay2/d6fa419223e9b3862664ba2520807eb394dea6db29c74120a2a98dcd9525bfbe/diff,workdir=/mnt/.ix-apps/docker/overlay2/d6fa419223e9b3862664ba2520807eb394dea6db29c74120a2a98dcd9525bfbe/work\n1963 1961 0:264 / /proc rw,nosuid,nodev,noexec,relatime - proc rw\n1964 1961 0:265 / /dev rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n1965 1964 0:266 / /dev/pts rw,nosuid,noexec,relatime - devpts rw,gid=5,mode=620,ptmxmode=666\n1966 1961 0:267 / /sys ro,nosuid,nodev,noexec,relatime - sysfs ro\n1967 1966 0:44 / /sys/fs/cgroup ro,nosuid,nodev,noexec,relatime - cgroup2 cgroup rw\n1968 1964 0:262 / /dev/mqueue rw,nosuid,nodev,noexec,relatime - mqueue rw\n1969 1964 0:268 / /dev/shm rw,nosuid,nodev,noexec,relatime - tmpfs shm rw,size=65536k,inode64\n1970 1961 0:99 /containers/068ee37abc16fddd40ae3013f37e20b2b63b4dc936bdfb695d292c7cece2d1db/resolv.conf /etc/resolv.conf rw,noatime - zfs apps-pool/ix-apps/docker rw,xattr,posixacl,casesensitive\n1971 1961 0:99 /containers/068ee37abc16fddd40ae3013f37e20b2b63b4dc936bdfb695d292c7cece2d1db/hostname /etc/hostname rw,noatime - zfs apps-pool/ix-apps/docker rw,xattr,posixacl,casesensitive\n1972 1961 0:99 /containers/068ee37abc16fddd40ae3013f37e20b2b63b4dc936bdfb695d292c7cece2d1db/hosts /etc/hosts rw,noatime - zfs apps-pool/ix-apps/docker rw,xattr,posixacl,casesensitive\n1842 1964 0:266 /0 /dev/console rw,nosuid,noexec,relatime - devpts rw,gid=5,mode=620,ptmxmode=666\n1843 1963 0:264 /bus /proc/bus ro,nosuid,nodev,noexec,relatime - proc rw\n1844 1963 0:264 /fs /proc/fs ro,nosuid,nodev,noexec,relatime - proc rw\n1845 1963 0:264 /irq /proc/irq ro,nosuid,nodev,noexec,relatime - proc rw\n1846 1963 0:264 /sys /proc/sys ro,nosuid,nodev,noexec,relatime - proc rw\n1847 1963 0:264 /sysrq-trigger /proc/sysrq-trigger ro,nosuid,nodev,noexec,relatime - proc rw\n1848 1963 0:269 / /proc/asound ro,relatime - tmpfs ro,inode64\n1849 1963 0:270 / /proc/acpi ro,relatime - tmpfs ro,inode64\n1850 1963 0:265 /null /proc/kcore rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n1851 1963 0:265 /null /proc/keys rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n1852 1963 0:265 /null /proc/timer_list rw,nosuid - tmpfs rw,size=65536k,mode=755,inode64\n1853 1966 0:271 / /sys/firmware ro,relatime - tmpfs ro,inode64\n1854 1966 0:272 / /sys/devices/virtual/powercap ro,relatime - tmpfs ro,inode64",
			expectedID: "068ee37abc16fddd40ae3013f37e20b2b63b4dc936bdfb695d292c7cece2d1db",
		},
		{
			name:       "Valid - Podman with Prefix /containers/overlay-containers/",
			content:    "1257 1263 0:134 /containers/overlay-containers/80079d07ae468bff52e0542c638d3c0e953ab1ff647f33248748dd38a1916aa1/userdata/.containerenv /run/.containerenv rw,nosuid,nodev,relatime - tmpfs rw,seclabel,size=374056k,nr_inodes=93514,mode=700,uid=1000,gid=1000,inode64\n1258 1263 0:134 /containers/overlay-containers/80079d07ae468bff52e0542c638d3c0e953ab1ff647f33248748dd38a1916aa1/userdata/run/secrets /run/secrets rw,nosuid,nodev,relatime - tmpfs rw,seclabel,size=374056k,nr_inodes=93514,mode=700,uid=1000,gid=1000,inode64\n1259 1263 0:134 /containers/overlay-containers/80079d07ae468bff52e0542c638d3c0e953ab1ff647f33248748dd38a1916aa1/userdata/hostname /etc/hostname rw,nosuid,nodev,relatime - tmpfs rw,seclabel,size=374056k,nr_inodes=93514,mode=700,uid=1000,gid=1000,inode64\n1260 1263 0:134 /containers/overlay-containers/80079d07ae468bff52e0542c638d3c0e953ab1ff647f33248748dd38a1916aa1/userdata/resolv.conf /etc/resolv.conf rw,nosuid,nodev,relatime - tmpfs rw,seclabel,size=374056k,nr_inodes=93514,mode=700,uid=1000,gid=1000,inode64\n1261 1263 0:134 /containers/overlay-containers/80079d07ae468bff52e0542c638d3c0e953ab1ff647f33248748dd38a1916aa1/userdata/hosts /etc/hosts rw,nosuid,nodev,relatime - tmpfs rw,seclabel,size=374056k,nr_inodes=93514,mode=700,uid=1000,gid=1000,inode64\n1262 1265 0:180 / /dev/shm rw,nosuid,nodev,noexec,relatime - tmpfs shm rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",size=64000k,uid=1000,gid=1000,inode64\n1263 1189 0:181 / rw,relatime - overlay rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",lowerdir=/home/core/.local/share/containers/storage/overlay/l/WQSWRQA3ZFQ6WWWF53DNPS6OC7:/home/core/.local/share/containers/storage/overlay/l/3X7WHJDHECVEERMTDIWBZ7O44N:/home/core/.local/share/containers/storage/overlay/l/FPNNGZY5GAZW2NDJIC6TEXFILU:/home/core/.local/share/containers/storage/overlay/l/E5SPCBZZO2K7ZENGON3JLGSEGO,upperdir=/home/core/.local/share/containers/storage/overlay/8cb38a209130729fa71be2702fc82a357cb58c4ca7e514db16f46a2da8383e0e/diff,workdir=/home/core/.local/share/containers/storage/overlay/8cb38a209130729fa71be2702fc82a357cb58c4ca7e514db16f46a2da8383e0e/work,uuid=on,volatile,userxattr\n1264 1263 0:186 / /proc rw,nosuid,nodev,noexec,relatime - proc rw\n1265 1263 0:187 / /dev rw,nosuid - tmpfs rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",size=65536k,mode=755,uid=1000,gid=1000,inode64\n1266 1263 0:188 / /sys ro,nosuid,nodev,noexec,relatime - sysfs rw,seclabel\n1267 1265 0:189 / /dev/pts rw,nosuid,noexec,relatime - devpts rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",gid=524292,mode=620,ptmxmode=666\n1268 1265 0:185 / /dev/mqueue rw,nosuid,nodev,noexec,relatime - mqueue rw,seclabel\n1269 1266 0:27 / /sys/fs/cgroup ro,nosuid,nodev,noexec,relatime - cgroup2 rw,seclabel,nsdelegate,memory_recursiveprot\n1270 1265 0:6 /null /dev/null rw,nosuid,noexec - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1271 1265 0:6 /zero /dev/zero rw,nosuid,noexec - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1272 1265 0:6 /full /dev/full rw,nosuid,noexec - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1273 1265 0:6 /tty /dev/tty rw,nosuid,noexec - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1274 1265 0:6 /random /dev/random rw,nosuid,noexec - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1275 1265 0:6 /urandom /dev/urandom rw,nosuid,noexec - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1276 1264 0:190 / /proc/acpi ro,relatime - tmpfs rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",size=0k,uid=1000,gid=1000,inode64\n1277 1264 0:6 /null /proc/kcore ro,nosuid - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1278 1264 0:6 /null /proc/keys ro,nosuid - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1279 1264 0:191 / /proc/scsi ro,relatime - tmpfs rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",size=0k,uid=1000,gid=1000,inode64\n1280 1264 0:6 /null /proc/timer_list ro,nosuid - devtmpfs rw,seclabel,size=4096k,nr_inodes=463297,mode=755,inode64\n1281 1266 0:192 / /sys/firmware ro,relatime - tmpfs rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",size=0k,uid=1000,gid=1000,inode64\n1282 1266 0:193 / /sys/fs/selinux ro,relatime - tmpfs rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",size=0k,uid=1000,gid=1000,inode64\n1283 1264 0:186 /bus /proc/bus ro,nosuid,nodev,noexec,relatime - proc rw\n1284 1264 0:186 /fs /proc/fs ro,nosuid,nodev,noexec,relatime - proc rw\n1285 1264 0:186 /irq /proc/irq ro,nosuid,nodev,noexec,relatime - proc rw\n1286 1264 0:186 /sys /proc/sys ro,nosuid,nodev,noexec,relatime - proc rw\n1287 1264 0:186 /sysrq-trigger /proc/sysrq-trigger ro,nosuid,nodev,noexec,relatime - proc rw\n1190 1265 0:189 /0 /dev/console rw,relatime - devpts rw,context=\"system_u:object_r:container_file_t:s0:c257,c777\",gid=524292,mode=620,ptmxmode=666",
			expectedID: "80079d07ae468bff52e0542c638d3c0e953ab1ff647f33248748dd38a1916aa1",
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			id := extractContainerIDFromMountInfo(tc.content)
			if id != tc.expectedID {
				t.Errorf("expected ID %q, got %q", tc.expectedID, id)
			}
		})
	}
}
