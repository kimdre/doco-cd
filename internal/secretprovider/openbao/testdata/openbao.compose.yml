name: openbao-dev

volumes:
  pg_data:
  bao_init:

configs:
  bao.conf:
    content: |
      storage "postgresql" {
        table = "openbao_kv_store"
        path    = "openbao/"
      }
        
      ui = true
      
      listener "tcp" {
        address = "0.0.0.0:8200"
        tls_disable = true
      }
        
      api_addr = "http://0.0.0.0:8200"
      plugin_directory = "/openbao/plugins"

services:
  db:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=postgresPW!
      - POSTGRES_USER=postgres
      - POSTGRES_DB=openbao
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -h localhost -U postgres -d openbao']
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - pg_data:/var/lib/postgresql/data

  vault:
    image: openbao/openbao:2
    command: ['server', '-config=/openbao/config/bao.conf']
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    ports:
      - "8200"  # random port on host to avoid conflicts
    depends_on:
      db:
        condition: service_healthy
    environment:
      - VAULT_ADDR=http://127.0.0.1:8200
      - VAULT_DISABLE_MLOCK=true
      - VAULT_PG_CONNECTION_URL=postgres://postgres:postgresPW!@db:5432/openbao?sslmode=disable
    deploy:
      resources:
        limits:
          memory: 512M
    healthcheck:
      interval: 2s
      retries: 30
      start_period: 5s
      test: 'wget --spider  http://127.0.0.1:8200/v1/sys/seal-status || exit 1'
      timeout: 5s
    volumes:
      - bao_init:/init
    configs:
      - source: bao.conf
        target: /openbao/config/bao.conf
